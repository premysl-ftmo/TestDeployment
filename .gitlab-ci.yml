stages:
  - package
  - docker

package app:
  stage: package
  image: mcr.microsoft.com/dotnet/sdk:9.0-noble
  script:
    - dotnet publish DeploymentTest -r linux-x64 --no-self-contained -o publish
  artifacts:
    paths:
      - publish/
    expire_in: 1 week

docker build app:
  stage: docker
  image: docker:20.10.16
  needs: ["package app"]
  services:
    - name: docker:20.10.16-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -f dockerfile -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA .
    - docker tag "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}" "${CI_REGISTRY_IMAGE}:latest"
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest